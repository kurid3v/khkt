{% extends 'base.html' %}
{% block title %}Danh sách bài nộp{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
  <!-- Header -->
  <header class="relative mb-12">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between bg-white rounded-xl shadow-md p-6 mb-8">
      <div class="flex items-center space-x-4">
        <div class="relative">
          <div class="w-14 h-14 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white text-xl transform -rotate-6 hover:rotate-0 transition-transform">
            <i class="fas fa-file-circle-check"></i>
          </div>
          <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg blur opacity-30"></div>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Danh sách bài đã nộp</h1>
          <p class="text-gray-500 text-sm mt-1">Xem và quản lý các bài tập đã nộp của bạn</p>
        </div>
      </div>
      <div class="mt-4 md:mt-0 flex items-center space-x-2">
        <a href="{% url 'problem_list' %}" class="inline-flex items-center px-4 py-2 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-lg transition-colors border-2 border-gray-200">
          <i class="fas fa-list-ul mr-2 text-gray-500"></i>
          Danh sách bài tập
        </a>
        <button class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 transition-colors" title="Lọc bài nộp">
          <i class="fas fa-filter"></i>
        </button>
      </div>
    </div>
  </header>

  {% if submissions %}
  <ul class="space-y-8">
    {% for submission in submissions %}
    <li class="bg-white rounded-lg shadow-sm hover:shadow-lg transition-all duration-300 group">
      <div class="relative p-6">
        <!-- Header with Title and Score -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
          <div class="flex-grow">
            <h2 class="text-lg font-semibold text-gray-800 group-hover:text-indigo-600 transition-colors truncate flex items-center" title="{{ submission.problem.title }}">
              <span class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center mr-3">
                <i class="fas fa-book text-indigo-500"></i>
              </span>
              {{ submission.problem.title }}
            </h2>
          </div>
          {% if submission.score is not None %}
          <div class="flex items-center">
            <div class="px-4 py-2 rounded-lg {% if submission.score >= 8 %}bg-emerald-50 text-emerald-700{% elif submission.score >= 5 %}bg-amber-50 text-amber-700{% else %}bg-red-50 text-red-700{% endif %} flex items-center space-x-2">
              <div>
                <div class="text-xs font-medium uppercase">Điểm số</div>
                <div class="text-lg font-bold">{{ submission.score }}/10</div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Info Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-indigo-50/50 transition-colors">
            <span class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center mr-3">
              <i class="fas fa-user text-indigo-600"></i>
            </span>
            <div>
              <div class="text-xs text-gray-500">Người nộp</div>
              <div class="font-semibold text-gray-900 truncate">{{ submission.user.username }}</div>
            </div>
          </div>
          <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-purple-50/50 transition-colors">
            <span class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center mr-3">
              <i class="fas fa-graduation-cap text-purple-600"></i>
            </span>
            <div>
              <div class="text-xs text-gray-500">Môn học</div>
              <div class="font-semibold text-gray-900 truncate">{{ submission.problem.get_subject_display }}</div>
            </div>
          </div>
          <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-indigo-50/50 transition-colors">
            <span class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center mr-3">
              <i class="fas fa-clock text-indigo-600"></i>
            </span>
            <div>
              <div class="text-xs text-gray-500">Thời gian</div>
              <div class="font-semibold text-gray-900">{{ submission.submitted_at|date:"H:i d/m/Y" }}</div>
            </div>
          </div>
          {% if submission.attempt_count %}
          <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-purple-50/50 transition-colors">
            <span class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center mr-3">
              <i class="fas fa-redo-alt text-purple-600"></i>
            </span>
            <div>
              <div class="text-xs text-gray-500">Lần thử</div>
              <div class="font-semibold text-gray-900">#{{ submission.attempt_count }}</div>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Actions -->
        <div class="mt-6 pt-6 border-t border-gray-100 flex flex-wrap items-center justify-between">
          <div class="flex items-center text-sm text-gray-500">
            <i class="fas fa-info-circle mr-2"></i>
            Nhấn "Xem kết quả" để xem chi tiết bài làm
          </div>
          <div class="flex flex-wrap gap-3">
            {% if submission.user == request.user or submission.problem.author == request.user %}
            <a href="{% url 'view_result' submission.id %}"
               class="inline-flex items-center px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-medium hover:from-indigo-600 hover:to-purple-700 transition-all duration-300 shadow-sm hover:shadow-md">
              <i class="fas fa-chart-bar mr-2"></i>
              Xem kết quả
            </a>
            {% endif %}
            {% if request.user == submission.problem.author %}
            <button onclick="showScoreModal('{{ submission.id }}', '{{ submission.problem.title }}')"
                    class="inline-flex items-center px-4 py-2 rounded-lg border-2 border-gray-200 text-gray-700 font-medium hover:bg-gray-50 hover:border-gray-300 transition-all duration-300">
              <i class="fas fa-edit mr-2"></i>
              Sửa điểm
            </button>
            {% endif %}
            {% if submission.can_retry %}
            <a href="{% url 'retry_problem' submission.problem.id %}"
               class="inline-flex items-center px-4 py-2 rounded-lg border-2 border-gray-200 text-gray-700 font-medium hover:bg-gray-50 hover:border-gray-300 transition-all duration-300">
              <i class="fas fa-redo-alt mr-2"></i>
              Làm lại
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <section class="text-center py-20 bg-white rounded-xl shadow-sm max-w-2xl mx-auto">
    <div class="relative mb-8">
      <div class="w-24 h-24 mx-auto rounded-2xl bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center transform -rotate-6 hover:rotate-0 transition-transform">
        <i class="fas fa-lightbulb text-4xl text-white"></i>
      </div>
      <div class="absolute inset-0 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur-xl opacity-20"></div>
    </div>
    <h2 class="text-3xl font-bold mb-4 bg-gradient-to-r from-indigo-500 to-purple-600 bg-clip-text text-transparent">
      Chưa có bài nộp nào
    </h2>
    <p class="mb-8 text-gray-600 max-w-md mx-auto">
      Hãy bắt đầu hành trình học tập của bạn bằng cách làm bài tập và theo dõi tiến độ tại đây!
    </p>
    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
      <a href="{% url 'problem_list' %}"
         class="inline-flex items-center px-6 py-3 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold hover:from-indigo-600 hover:to-purple-700 transition-all duration-300 shadow-sm hover:shadow-lg group">
        <i class="fas fa-rocket mr-2 group-hover:translate-x-1 transition-transform"></i>
        Bắt đầu làm bài
      </a>
      <a href="#" class="text-gray-500 hover:text-gray-700 transition-colors flex items-center">
        <i class="fas fa-question-circle mr-2"></i>
        Hướng dẫn sử dụng
      </a>
    </div>
  </section>
  {% endif %}
</div>

<!-- Score Update Modal -->
<div id="score-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
  <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md mx-4 transform transition-transform scale-95 duration-200">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">Sửa điểm</h3>
      <button onclick="hideScoreModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="text-gray-600 mb-4">
      Đang sửa điểm cho bài nộp của bài tập: <br>
      <span id="modal-problem-title" class="font-semibold text-gray-800 text-lg"></span>
    </div>
    <form id="score-form" method="POST">
      {% csrf_token %}
      <div class="mb-4">
        <label for="new-score" class="block text-sm font-medium text-gray-700 mb-2">Điểm số mới</label>
        <input type="number" id="new-score" name="score" step="0.5" min="0" max="10"
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow"
               placeholder="Nhập điểm mới (0-10)" required>
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="hideScoreModal()"
                class="px-4 py-2 rounded-lg text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors">
          Hủy bỏ
        </button>
        <button type="submit"
                class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-medium hover:bg-indigo-700 transition-colors shadow-md">
          Cập nhật điểm
        </button>
      </div>
    </form>
    <div id="status-message" class="mt-4 text-center hidden"></div>
  </div>
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showScoreModal(submissionId, problemTitle) {
    const modal = document.getElementById('score-modal');
    const form = document.getElementById('score-form');
    document.getElementById('modal-problem-title').innerText = problemTitle;
    form.action = `/submissions/${submissionId}/update_score/`;
    modal.classList.remove('hidden');
    document.getElementById('new-score').focus();
  }

  function hideScoreModal() {
    const modal = document.getElementById('score-modal');
    modal.classList.add('hidden');
    document.getElementById('status-message').innerText = '';
    document.getElementById('status-message').classList.add('hidden');
  }

  document.getElementById('score-form').addEventListener('submit', function(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const submissionId = form.action.split('/')[4];
    const statusMessage = document.getElementById('status-message');

    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
      },
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
      statusMessage.classList.remove('hidden');
      if (status === 200) {
        statusMessage.className = 'mt-4 text-center text-emerald-600 font-semibold';
        statusMessage.innerText = body.message;
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        statusMessage.className = 'mt-4 text-center text-red-600 font-semibold';
        statusMessage.innerText = body.error || 'Đã có lỗi xảy ra.';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      statusMessage.classList.remove('hidden');
      statusMessage.className = 'mt-4 text-center text-red-600 font-semibold';
      statusMessage.innerText = 'Kết nối thất bại. Vui lòng thử lại.';
    });
  });
</script>
{% endblock %}
